<?php

/**
 * @file
 * Node tests for Amazon module.
 */

class AmazonAdminUITest extends AmazonBaseTest {
  protected $admin_user;

  /**
   * @inheritdoc
   *
   * @return array
   */
  public static function getInfo() {
    return array(
      'name' => 'Admin UI',
      'description' => 'Tests for the Admin UI.',
      'group' => 'Amazon',
    );
  }

  /**
   * @inheritdoc
   *
   * @param array $modules
   */
  protected function setUp($modules = array()) {
    // Enable modules.
    parent::setUp($modules);
  }

  /**
   * Helper to create ASIN text fields.
   *
   * @param $widget
   *   The widget: asin_text or asin_autocomplete.
   * @param $locale
   *   The locale.
   */
  protected function createAsinFieldInstance($widget, $locale) {
    $this->drupalGet('admin/structure/types/manage/article');

    $field_name = substr('asin_' . strtolower($locale) . '_' . $widget, 0, 26);
    $field_label = 'ASIN ' . $locale . ' (' . $widget . ')';

    $this->clickLink(t('Manage fields'));
    $edit = [
      'fields[_add_new_field][field_name]' => $field_name,
      'fields[_add_new_field][label]' => $field_label,
      'fields[_add_new_field][type]' => 'asin',
      'fields[_add_new_field][widget_type]' => $widget,
    ];
    $this->drupalPost(NULL, $edit, t('Save'));
    $this->drupalPost(NULL, array(), t('Save field settings'));
    $this->drupalGet('admin/structure/types/manage/article/fields/field_' . $field_name);
    $edit = [
      'instance[widget][settings][widget_settings][locale]' => $locale,
    ];
    $this->drupalPost(NULL, $edit, t('Save settings'));
  }

  /**
   * Test the admin UI.
   */
  public function testAdminUI() {
    // Login as an admin user.
    $this->drupalLogin($this->admin_user);

    // Create fields.
    $this->createAsinFieldInstance('asin_text', 'US');
    $this->createAsinFieldInstance('asin_text', 'UK');
    $this->createAsinFieldInstance('asin_autocomplete', 'US');
    $this->createAsinFieldInstance('asin_autocomplete', 'UK');

    // Check that fields have been created;
    $this->drupalGet('admin/structure/types/manage/article/fields');

    $this->assertLink('Amazon ASIN Text field');

    $this->assertRaw('ASIN US (asin_text)');
    $this->assertRaw('field_asin_us_asin_text');

    $this->assertRaw('ASIN UK (asin_text)');
    $this->assertRaw('field_asin_uk_asin_text');

    $this->assertLink('Product name autocomplete');

    $this->assertRaw('ASIN US (asin_autocomplete)');
    $this->assertRaw('field_asin_us_asin_autocomplete');

    $this->assertRaw('ASIN UK (asin_autocomplete)');
    $this->assertRaw('field_asin_uk_asin_autocomplete');

    // Add new article and fill in the text fields.
    $this->drupalGet('node/add/');
    $this->drupalGet('node/add/article');
    $edit = [
      'title' => 'Testing UK and US ASIN text fields',
      'field_asin_us_asin_text[und][0][asin]' => 'B001CEE1YE',
      'field_asin_uk_asin_text[und][0][asin]' => 'B001CEE1YE',
    ];
    $this->drupalPost(NULL, $edit, t('Save'));

    $this->assertRaw('amazon-product--container amazon-item amazon-item-dvd amazon-item-default locale-us', t('All wrapper classes are present'));
    $this->assertRaw('ASIN US (asin_text)', t('The field label is correct'));
    $this->assertRaw('The Complete Matrix Trilogy', t('The item title is correct'));

    $this->assertRaw('amazon-product--container amazon-item amazon-item-dvd amazon-item-default locale-uk', t('All wrapper classes are present'));
    $this->assertRaw('ASIN UK (asin_text)', t('The field label is correct'));
    $this->assertRaw('Complete Matrix Trilogy [Blu-ray] [1999] [Region Free]', t('The item title is correct'));

    // Add new article and fill in the autocomplete fields.
    $this->drupalGet('node/add/article');
    $edit = [
      'title' => 'Testing UK and US ASIN autocomplete fields',
      'field_asin_us_asin_autocomplete[und][0][asin]' => 'B001CEE1YE',
      'field_asin_uk_asin_autocomplete[und][0][asin]' => 'B001CEE1YE',
    ];
    $this->drupalPost(NULL, $edit, t('Save'));

    $this->assertRaw('amazon-product--container amazon-item amazon-item-dvd amazon-item-default locale-us', t('All wrapper classes are present'));
    $this->assertRaw('ASIN US (asin_autocomplete)', t('The field label is correct'));
    $this->assertRaw('The Complete Matrix Trilogy', t('The item title is correct'));

    $this->assertRaw('amazon-product--container amazon-item amazon-item-dvd amazon-item-default locale-uk', t('All wrapper classes are present'));
    $this->assertRaw('ASIN UK (asin_autocomplete)', t('The field label is correct'));
    $this->assertRaw('Complete Matrix Trilogy [Blu-ray] [1999] [Region Free]', t('The item title is correct'));
  }

}
